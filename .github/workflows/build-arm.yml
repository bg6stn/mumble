name: Build Mumble for ARM

on:
  workflow_dispatch:  # 只允许手动触发，避免自动触发超时

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 设置60分钟超时
    
    strategy:
      matrix:
        arch: [arm64]
        # 先只构建arm64，成功后添加armv7

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1  # 只拉取最新commit，加快速度

    - name: Setup QEMU
      uses: docker/setup-qemu-action@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          qtbase5-dev \
          libqt5svg5-dev \
          qttools5-dev \
          libboost-dev \
          libssl-dev \
          libprotobuf-dev \
          protobuf-compiler \
          libogg-dev \
          libsndfile1-dev \
          libopus-dev \
          libavahi-compat-libdnssd-dev

    - name: Configure with CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -Dbundled-celt=ON

    - name: Build (parallel)
      run: |
        cd build
        make -j2  # 减少并行数，避免资源不足
        # 或者使用: make --jobs 2 --keep-going

    - name: List artifacts
      run: |
        find build -name "mumble" -type f || echo "mumble not found"
        find build -name "murmurd" -type f || echo "murmurd not found"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mumble-${{ matrix.arch }}
        path: |
          build/release/mumble
          build/release/murmurd
        retention-days: 7
